import{d as F,B as w,e as V,f as G,g as J,h as L,i as W}from"./ui-library-BNKiWr2G.js";import{V as Q,r as A,k as U,M as f,O as _,R as v,P as k,L as m,j as Y,N as M,Y as N,F as R,Z as O,Q as $,_ as z,c as Z,$ as q}from"./vue-vendor-Bi-VIAV2.js";import{d as I,u as P,_ as T}from"./index-C6H1Hdn7.js";import{r as D}from"./record.service-BTSfs8Wh.js";function H(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{const o=Math.random()*16|0;return(c==="x"?o:o&3|8).toString(16)})}function E(c){return c[Math.floor(Math.random()*c.length)]}class K{async generate(o,x,d,h=I().format("YYYY-MM-DD")){const B=[],a=JSON.parse(JSON.stringify(o));for(let i=0;i<d;i++){const e=I(h).add(i,"day").format("YYYY-MM-DD");["A","B","C"].forEach(s=>{a[s].length===0&&(a[s]=[...x[s]])});const n={A:E(a.A),B:E(a.B),C:E(a.C)};a.A.splice(a.A.indexOf(n.A),1),a.B.splice(a.B.indexOf(n.B),1),a.C.splice(a.C.indexOf(n.C),1),B.push({id:H(),date:e,schemeId:"",meals:n,isConfirmed:!1,createdAt:new Date().toISOString()})}return B}validateRecommendation(o){return o.date&&o.meals.A&&o.meals.B&&o.meals.C&&/^\d{4}-\d{2}-\d{2}$/.test(o.date)}}const X=new K,j=Q("recommendation",()=>{const c=A([]),o=A(!1),x=A({A:[],B:[],C:[]});function d(e,t){const n={A:[...e.A],B:[...e.B],C:[...e.C]},p=P().currentSchemeId;return t.filter(u=>u.schemeId===p).forEach(u=>{["A","B","C"].forEach(C=>{const r=u.meals[C];if(r==="å…¶ä»–"||r.startsWith("å…¶ä»–:"))return;const l=n[C],S=l.indexOf(r);S!==-1&&l.splice(S,1)})}),n}async function h(e){let t=I(e);const n=30;let s=0;for(;s<n;){const p=t.format("YYYY-MM-DD");if(!await D.getByDate(p))return p;t=t.add(1,"day"),s++}return t.format("YYYY-MM-DD")}async function B(e,t){o.value=!0;try{const n=P(),s=t||I().format("YYYY-MM-DD"),p=await h(s),u=await D.getAll(),y=d(n.currentScheme?.originalPools||n.currentPools,u),C=await X.generate(y,n.currentScheme?.originalPools||n.currentPools,e,p);return x.value=y,c.value=C,C}finally{o.value=!1}}async function a(e){const t=c.value.find(u=>u.id===e);if(!t)return;const n=await D.getByDate(t.date);let s;n?s=await D.update(n.id,{meals:t.meals,schemeId:t.schemeId,schemeName:"current"}):s=await D.create({date:t.date,schemeId:t.schemeId,schemeName:"current",meals:t.meals});const p=P();return Object.entries(t.meals).forEach(([u,y])=>{if(y==="å…¶ä»–"||typeof y=="string"&&y.startsWith("å…¶ä»–:"))return;const C=p.currentPools[u],r=C.indexOf(y);r!==-1&&C.splice(r,1)}),Object.keys(p.currentPools).forEach(u=>{p.currentPools[u].length===0&&p.resetPool(u)}),t.isConfirmed=!0,s}function i(e,t){const n=c.value.find(s=>s.id===e);n&&(n.meals=t)}return{recommendations:c,loading:o,remainingPools:x,generateRecommendations:B,confirmRecommendation:a,updateRecommendationMeals:i}}),ee={class:"recommend-form"},te=U({__name:"RecommendForm",props:{loading:{type:Boolean}},emits:["generate"],setup(c,{emit:o}){const x=o,d=A(1);function h(){if(d.value<1||d.value>30){window.$message?.error("æ¨èæ•°é‡åº”åœ¨1-30ä¹‹é—´");return}x("generate",d.value)}return(B,a)=>(m(),f("div",ee,[_(v(F),{label:"æ¨èæ•°é‡"},{default:k(()=>[_(v(V),{value:d.value,"onUpdate:value":a[0]||(a[0]=i=>d.value=i),min:1,max:30,placeholder:"è¯·è¾“å…¥æ¨èæ•°é‡"},null,8,["value"])]),_:1}),_(v(w),{type:"primary",loading:c.loading,onClick:h},{default:k(()=>[...a[1]||(a[1]=[Y(" ç”Ÿæˆæ¨è ",-1)])]),_:1},8,["loading"])]))}}),ne=T(te,[["__scopeId","data-v-4b34bef5"]]),ae={class:"recommend-item"},oe={class:"date"},se={key:0,class:"meals"},le={class:"group-label"},ie={class:"dish-name"},ce={key:1,class:"meals-edit"},re={class:"group-label"},me={class:"meal-edit-content"},de={key:2,class:"actions"},ue={key:3,class:"confirmed"},fe=U({__name:"RecommendItem",props:{recommendation:{}},emits:["edit","confirm","update"],setup(c,{emit:o}){const x=c,d=o,h=j(),B=P(),a=A(!1),i=A({A:"",B:"",C:""}),e=A({A:"",B:"",C:""}),t=Z(()=>{const r=h.remainingPools.A.length>0||h.remainingPools.B.length>0||h.remainingPools.C.length>0?h.remainingPools:B.currentPools,l=S=>[...S.map(g=>({label:g,value:g})),{label:"å…¶ä»–",value:"å…¶ä»–"}];return{A:l(r.A),B:l(r.B),C:l(r.C)}});function n(r){return I(r).format("YYYYå¹´MMæœˆDDæ—¥")}function s(){i.value={...x.recommendation.meals},e.value={A:"",B:"",C:""},a.value=!0}function p(){a.value=!1,e.value={A:"",B:"",C:""}}function u(r,l){i.value[r]=l,l==="å…¶ä»–"&&(e.value[r]="")}function y(){const r={A:i.value.A==="å…¶ä»–"?e.value.A||"å…¶ä»–":i.value.A,B:i.value.B==="å…¶ä»–"?e.value.B||"å…¶ä»–":i.value.B,C:i.value.C==="å…¶ä»–"?e.value.C||"å…¶ä»–":i.value.C};d("update",r),a.value=!1,e.value={A:"",B:"",C:""}}function C(){d("confirm")}return(r,l)=>(m(),f("div",ae,[M("div",oe,N(n(c.recommendation.date)),1),a.value?(m(),f("div",ce,[(m(!0),f(R,null,O(i.value,(S,g)=>(m(),f("div",{key:g,class:"meal-edit-item"},[M("span",re,N(g)+"ç»„:",1),M("div",me,[_(v(G),{value:S,options:t.value[g],filterable:"",size:"small",style:{flex:"1"},"onUpdate:value":b=>u(g,b)},null,8,["value","options","onUpdate:value"]),S==="å…¶ä»–"?(m(),$(v(J),{key:0,value:e.value[g],placeholder:"è¯·è¾“å…¥è‡ªå®šä¹‰èœå“åç§°",size:"small",clearable:"",style:{flex:"1","margin-top":"0.5rem"},"onUpdate:value":b=>e.value[g]=b},null,8,["value","onUpdate:value"])):z("",!0)])]))),128))])):(m(),f("div",se,[(m(!0),f(R,null,O(c.recommendation.meals,(S,g)=>(m(),f("div",{key:g,class:"meal-item"},[M("span",le,N(g)+"ç»„:",1),M("span",ie,N(S),1)]))),128))])),c.recommendation.isConfirmed?(m(),f("div",ue,[_(v(L),{type:"success"},{default:k(()=>[...l[4]||(l[4]=[Y("å·²ç¡®è®¤",-1)])]),_:1})])):(m(),f("div",de,[a.value?(m(),f(R,{key:1},[_(v(w),{size:"small",onClick:p},{default:k(()=>[...l[2]||(l[2]=[Y("å–æ¶ˆ",-1)])]),_:1}),_(v(w),{type:"primary",size:"small",onClick:y},{default:k(()=>[...l[3]||(l[3]=[Y("ä¿å­˜",-1)])]),_:1})],64)):(m(),f(R,{key:0},[_(v(w),{size:"small",onClick:s},{default:k(()=>[...l[0]||(l[0]=[Y("ç¼–è¾‘",-1)])]),_:1}),_(v(w),{type:"primary",size:"small",onClick:C},{default:k(()=>[...l[1]||(l[1]=[Y("ç¡®è®¤",-1)])]),_:1})],64))]))]))}}),ve=T(fe,[["__scopeId","data-v-7be767ab"]]),pe={class:"recommend"},xe={key:0,class:"recommendations"},he=U({__name:"Recommend",setup(c){const o=j(),{recommendations:x,loading:d}=q(o);async function h(e){await o.generateRecommendations(e)}function B(e){console.log("ç¼–è¾‘æ¨è",e)}function a(e,t){o.updateRecommendationMeals(e.id,t),window.$message?.success("æ¨èå·²æ›´æ–°")}async function i(e){await o.confirmRecommendation(e.id),window.$message?.success("è®°å½•å·²åˆ›å»º")}return(e,t)=>(m(),f("div",pe,[t[0]||(t[0]=M("h1",null,"èœå“æ¨è ğŸ²",-1)),_(ne,{loading:v(d),onGenerate:h},null,8,["loading"]),v(x).length>0?(m(),f("div",xe,[(m(!0),f(R,null,O(v(x),n=>(m(),$(ve,{key:n.id,recommendation:n,onEdit:s=>B(n),onConfirm:s=>i(n),onUpdate:s=>a(n,s)},null,8,["recommendation","onEdit","onConfirm","onUpdate"]))),128))])):v(d)?z("",!0):(m(),$(v(W),{key:1,description:"æš‚æ— æ¨èï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆæ¨è"}))]))}}),Be=T(he,[["__scopeId","data-v-27cc0619"]]);export{Be as default};
